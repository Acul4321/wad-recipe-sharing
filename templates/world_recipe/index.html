{% extends "world_recipe/base.html" %}
{% load static %}

{% block title %}
    Home 
{% endblock %}

{% block body %}
<div class="container"></div>
    <h1 class="text-centre my-4">Travel the world from your kitchen!</h1>
    <p class="lead text-centre">Cooking up a cultural cuisine at your home is easier than you think</p>
    <p class="lead text-centre mb-4">Where will you travel today?</p>

    <!-- Add map container -->
    <div id="recipe-map" style="height: 400px; width: 100%; margin: 20px 0;"></div>

    <!-- Initialize map with recipe locations -->
    <script src="https://maps.googleapis.com/maps/api/js?key={{ google_maps_api_key }}"></script>
    <script>
        function initMap() {
            const map = new google.maps.Map(document.getElementById('recipe-map'), {
                zoom: 2,
                center: { lat: 20, lng: 0 }
            });

            // Create a Set to track unique recipe slugs
            const seenRecipes = new Set();
            const recipes = [];

            // Get all recipes (not just most recent or rated)
            [
                {% for recipe in all_recipes %}
                    {
                        title: "{{ recipe.title }}",
                        country: "{{ recipe.get_country_name }}",
                        url: "{% url 'world_recipe:recipe' country=recipe.get_country_name|slugify meal_type=recipe.get_meal_type|slugify recipe_name=recipe.slug %}",
                        slug: "{{ recipe.slug }}"
                    },
                {% endfor %}
            ].forEach(recipe => {
                if (!seenRecipes.has(recipe.slug)) {
                    seenRecipes.add(recipe.slug);
                    recipes.push(recipe);
                }
            });

            // Create a map of unique countries
            const uniqueCountries = new Map();
            recipes.forEach(recipe => {
                if (!uniqueCountries.has(recipe.country)) {
                    uniqueCountries.set(recipe.country, []);
                }
                uniqueCountries.get(recipe.country).push(recipe);
            });

            // Geocode each country and add markers
            uniqueCountries.forEach((recipes, country) => {
                const geocoder = new google.maps.Geocoder();
                geocoder.geocode({ address: country }, (results, status) => {
                    if (status === 'OK') {
                        const marker = new google.maps.Marker({
                            map: map,
                            position: results[0].geometry.location,
                            title: country
                        });

                        // Create info window content
                        const contentString = `
                            <div class="map-info-window">
                                <h3><a href="/world_recipe/country/${country.toLowerCase().replace(/\s+/g, '-')}/">${country}</a></h3>
                                <ul>
                                    ${recipes.map(recipe => `
                                        <li><a href="${recipe.url}">${recipe.title}</a></li>
                                    `).join('')}
                                </ul>
                            </div>
                        `;

                        const infowindow = new google.maps.InfoWindow({
                            content: contentString
                        });

                        marker.addListener('click', () => {
                            infowindow.open(map, marker);
                        });
                    }
                });
            });
        }

        window.onload = initMap;
    </script>

    <div class="mt-5">
    <h2 class="text-center mt-5 mb-4">Most Recent Recipes</h2>
    <ul class="list-group">
        {% for recipe in most_recent_recipes %}
            <li class="list-group-item">
                <a href="{% url 'world_recipe:recipe' country=recipe.get_country_name|slugify meal_type=recipe.get_meal_type|slugify recipe_name=recipe.slug %}">
                    {% if recipe.image %}
                        <img src="{{ recipe.image.url }}" alt="{{ recipe.title }}" style="width: 200px; height: 150px;">
                    {% else %}
                        <img src="{% static 'images/logo.png' %}" alt="No image found" style="width: 200px; height: 150px;">
                    {% endif %}
                </a><br>
                <strong>{{ recipe.title }}</strong><br>
                <a href="{% url 'world_recipe:country' country=recipe.get_country_name|slugify %}">
                    Region: {{ recipe.get_country_name }}
                </a><br>
                <a href="{% url 'world_recipe:recipe' country=recipe.get_country_name|slugify meal_type=recipe.get_meal_type|slugify recipe_name=recipe.slug %}">View Recipe</a>
            </li>
        {% empty %}
            <p class="text-centre">No recent recipes found. </p>
        {% endfor %}
    </ul>

    <h2 class="text-center mt-5 mb-4">Highest Rated Recipes</h2>
    <ul class="list-group">
        {% for recipe in most_rated_recipes %}
            <li class="list-group-item">
                <a href="{% url 'world_recipe:recipe' country=recipe.get_country_name|slugify meal_type=recipe.get_meal_type|slugify recipe_name=recipe.slug %}">
                    {% if recipe.image %}
                        <img src="{{ recipe.image.url }}" alt="{{ recipe.title }}" style="width: 200px; height: 150px;">
                    {% else %}
                        <img src="{% static 'images/logo.png' %}" alt="No image found" style="width: 200px; height: 150px;">
                    {% endif %}
                </a><br>
                <strong>{{ recipe.title }}</strong><br>
                <a href="{% url 'world_recipe:country' country=recipe.get_country_name|slugify %}">
                    Region: {{ recipe.get_country_name }}
                </a><br>
                <span style="color: #1b7508; text-decoration: none;">Rating: {{ recipe.avg_rating|floatformat:1 }}</span><br>
                <a href="{% url 'world_recipe:recipe' country=recipe.get_country_name|slugify meal_type=recipe.get_meal_type|slugify recipe_name=recipe.slug %}">View Recipe</a>
            </li>
        {% empty %}
            <p class="text-center">No rated recipes found. </p>
        {% endfor %}
    </ul>
{% endblock %}
